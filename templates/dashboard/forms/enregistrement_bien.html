{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Enregistrer un bien immobilier - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        background: #f8fafc;
        min-height: 100vh;
    }

    .page-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 20px;
        padding: 3rem 2rem;
        color: white;
        text-align: center;
        margin-bottom: 3rem;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
    }

    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.75rem;
    }

    .page-header p {
        font-size: 1.125rem;
        color: #dbeafe;
    }

    .type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .type-card {
        background: white;
        border: 4px solid #e5e7eb;
        border-radius: 20px;
        padding: 2.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .type-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
    }

    .type-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
        border-color: #3b82f6;
    }

    .type-card.active {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 15px 35px rgba(59, 130, 246, 0.25);
    }

    .type-card-content {
        position: relative;
        z-index: 1;
    }

    .type-card .icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        color: #6b7280;
        transition: all 0.3s ease;
    }

    .type-card.active .icon {
        color: #3b82f6;
        transform: scale(1.1);
    }

    .type-card h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
    }

    .type-card p {
        color: #6b7280;
        font-size: 0.9375rem;
        line-height: 1.6;
    }

    .type-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #3b82f6;
        color: white;
        padding: 0.375rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: none;
    }

    .type-card.active .type-badge {
        display: block;
        animation: bounceIn 0.5s ease;
    }

    @keyframes bounceIn {
        0% { transform: scale(0); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .form-container {
        background: white;
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        display: none;
        animation: slideIn 0.4s ease;
    }

    .form-container.active {
        display: block;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.375rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid #e5e7eb;
    }

    .section-title i {
        color: #3b82f6;
        font-size: 1.5rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.75rem;
        margin-bottom: 2.5rem;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.625rem;
        font-size: 0.9375rem;
    }

    .required {
        color: #ef4444;
        margin-left: 0.25rem;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1.125rem;
        border: 2px solid #d1d5db;
        border-radius: 12px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .form-control:hover {
        border-color: #9ca3af;
    }

    .form-control.error {
        border-color: #ef4444;
        background: #fef2f2;
    }

    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
        background-position: right 1rem center;
        background-repeat: no-repeat;
        background-size: 1.25em;
        padding-right: 3rem;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
    }

    .help-text {
        font-size: 0.8125rem;
        color: #6b7280;
        margin-top: 0.5rem;
        font-style: italic;
    }

    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .checkbox-item:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .checkbox-item input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
        accent-color: #3b82f6;
    }

    .checkbox-item label {
        cursor: pointer;
        font-weight: 500;
        color: #374151;
        font-size: 0.9375rem;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #e5e7eb;
    }

    .btn {
        padding: 1rem 2.5rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .info-banner {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #93c5fd;
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .info-banner h4 {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 0.75rem;
    }

    .info-list li {
        color: #1e3a8a;
        font-size: 0.875rem;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .info-list li i {
        color: #3b82f6;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- En-tête de la page -->
    <div class="page-header">
        <h1>
            <i class="fas fa-building"></i>
            Enregistrer un bien immobilier
        </h1>
        <p>Ajoutez une nouvelle résidence ou un nouvel appartement à votre portefeuille</p>
    </div>

    <!-- Sélecteur de type de bien -->
    <div class="type-selector">
        <div class="type-card" id="card-residence" onclick="selectType('residence')">
            <span class="type-badge"><i class="fas fa-check"></i> Sélectionné</span>
            <div class="type-card-content">
                <div class="icon">
                    <i class="fas fa-building"></i>
                </div>
                <h3>Résidence / Immeuble</h3>
                <p>Enregistrer un bâtiment complet pouvant contenir plusieurs logements (immeuble, villa, duplex, etc.)</p>
            </div>
        </div>

        <div class="type-card" id="card-appartement" onclick="selectType('appartement')">
            <span class="type-badge"><i class="fas fa-check"></i> Sélectionné</span>
            <div class="type-card-content">
                <div class="icon">
                    <i class="fas fa-home"></i>
                </div>
                <h3>Appartement / Logement</h3>
                <p>Enregistrer un logement individuel dans une résidence existante (studio, F2, F3, etc.)</p>
            </div>
        </div>
    </div>

    <!-- Formulaire pour Résidence -->
    <div class="form-container" id="form-residence">
        <form method="post" action="{% url 'properties:residence_create' %}">
            {% csrf_token %}

            <!-- Informations générales -->
            <div class="section-title">
                <i class="fas fa-info-circle"></i>
                <span>Informations générales</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nom de la résidence<span class="required">*</span></label>
                    <input type="text" name="nom" class="form-control" placeholder="Ex: Résidence Les Palmiers" required>
                    <div class="help-text">Le nom commercial ou d'identification de votre résidence</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Type de résidence<span class="required">*</span></label>
                    <select name="type_residence" class="form-control" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="immeuble">Immeuble</option>
                        <option value="villa">Villa</option>
                        <option value="duplex">Duplex</option>
                        <option value="triplex">Triplex</option>
                        <option value="residence">Résidence fermée</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Propriétaire<span class="required">*</span></label>
                    <select name="proprietaire" class="form-control" required>
                        <option value="">-- Sélectionner un propriétaire --</option>
                        {% for prop in proprietaires %}
                        <option value="{{ prop.id }}">
                            {{ prop.nom_complet }}
                            {% if prop.entreprise %} - {{ prop.entreprise }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="help-text">Le propriétaire légal de cette résidence</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select name="statut" class="form-control">
                        <option value="active" selected>Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="en_construction">En construction</option>
                    </select>
                </div>
            </div>

            <!-- Localisation -->
            <div class="section-title">
                <i class="fas fa-map-marker-alt"></i>
                <span>Localisation</span>
            </div>

            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Adresse complète<span class="required">*</span></label>
                    <textarea name="adresse" class="form-control" placeholder="Rue, numéro, avenue..." required></textarea>
                    <div class="help-text">Adresse physique complète de la résidence</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Quartier<span class="required">*</span></label>
                    <input type="text" name="quartier" class="form-control" placeholder="Ex: Almadies, Plateau" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Ville<span class="required">*</span></label>
                    <input type="text" name="ville" class="form-control" value="Dakar" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Code postal</label>
                    <input type="text" name="code_postal" class="form-control" placeholder="Optionnel">
                </div>
            </div>

            <!-- Caractéristiques -->
            <div class="section-title">
                <i class="fas fa-ruler-combined"></i>
                <span>Caractéristiques techniques</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nombre d'étages</label>
                    <input type="number" name="nb_etages" class="form-control" min="0" value="1">
                    <div class="help-text">0 pour uniquement RDC</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre total d'appartements</label>
                    <input type="number" name="nb_appartements_total" class="form-control" min="1" value="1">
                    <div class="help-text">Capacité maximale prévue</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Année de construction</label>
                    <input type="number" name="annee_construction" class="form-control" min="1900" max="2030" placeholder="Ex: 2020">
                </div>
            </div>

            <!-- Description -->
            <div class="section-title">
                <i class="fas fa-align-left"></i>
                <span>Description et équipements</span>
            </div>

            <div class="form-group">
                <label class="form-label">Description de la résidence</label>
                <textarea name="description" class="form-control" placeholder="Décrivez les atouts de la résidence..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Équipements communs</label>
                <textarea name="equipements" class="form-control" placeholder="Ascenseur, Parking, Gardien, Piscine, etc."></textarea>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Enregistrer la résidence
                </button>
            </div>
        </form>
    </div>

    <!-- Formulaire pour Appartement -->
    <div class="form-container" id="form-appartement">
        <form method="post" action="{% url 'properties:appartement_create' %}">
            {% csrf_token %}

            <!-- Résidence parente -->
            <div class="section-title">
                <i class="fas fa-building"></i>
                <span>Résidence</span>
            </div>

            <div class="form-group">
                <label class="form-label">Sélectionner la résidence<span class="required">*</span></label>
                <select name="residence" class="form-control" required>
                    <option value="">-- Choisir une résidence --</option>
                    {% for residence in residences %}
                    <option value="{{ residence.id }}">
                        {{ residence.nom }} - {{ residence.quartier }}, {{ residence.ville }}
                    </option>
                    {% endfor %}
                </select>
                <div class="help-text">La résidence où se trouve cet appartement</div>
            </div>

            <!-- Informations de base -->
            <div class="section-title">
                <i class="fas fa-tag"></i>
                <span>Informations de base</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nom/Numéro<span class="required">*</span></label>
                    <input type="text" name="nom" class="form-control" placeholder="Ex: Appt 101, Studio A" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Type de bien<span class="required">*</span></label>
                    <select name="type_bien" class="form-control" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="studio">Studio</option>
                        <option value="appartement">Appartement</option>
                        <option value="duplex">Duplex</option>
                        <option value="triplex">Triplex</option>
                        <option value="villa">Villa</option>
                        <option value="chambre">Chambre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Étage</label>
                    <input type="number" name="etage" class="form-control" min="-1" value="0" placeholder="0 = RDC, -1 = Sous-sol">
                </div>

                <div class="form-group">
                    <label class="form-label">Statut d'occupation</label>
                    <select name="statut_occupation" class="form-control">
                        <option value="libre" selected>Libre</option>
                        <option value="occupe">Occupé</option>
                        <option value="maintenance">En maintenance</option>
                    </select>
                </div>
            </div>

            <!-- Caractéristiques -->
            <div class="section-title">
                <i class="fas fa-ruler-combined"></i>
                <span>Caractéristiques</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Superficie (m²)<span class="required">*</span></label>
                    <input type="number" name="superficie" class="form-control" step="0.01" min="1" placeholder="Ex: 45.5" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre de pièces<span class="required">*</span></label>
                    <input type="number" name="nb_pieces" class="form-control" min="1" value="1" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre de chambres</label>
                    <input type="number" name="nb_chambres" class="form-control" min="0" value="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Salles de bain</label>
                    <input type="number" name="nb_sdb" class="form-control" min="0" value="1">
                </div>

                <div class="form-group">
                    <label class="form-label">WC</label>
                    <input type="number" name="nb_wc" class="form-control" min="0" value="1">
                </div>
            </div>

            <!-- Tarification -->
            <div class="section-title">
                <i class="fas fa-money-bill-wave"></i>
                <span>Tarification</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Loyer de base (FCFA)<span class="required">*</span></label>
                    <input type="number" name="loyer_base" class="form-control" min="0" step="1000" placeholder="Ex: 150000" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Charges mensuelles (FCFA)</label>
                    <input type="number" name="charges" class="form-control" min="0" step="1000" value="0" placeholder="Ex: 20000">
                </div>

                <div class="form-group">
                    <label class="form-label">Dépôt de garantie (FCFA)</label>
                    <input type="number" name="depot_garantie" class="form-control" min="0" step="1000" placeholder="Ex: 300000">
                    <div class="help-text">Généralement 2 mois de loyer</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Frais d'agence (FCFA)</label>
                    <input type="number" name="frais_agence" class="form-control" min="0" step="1000" value="0">
                </div>
            </div>

            <!-- Équipements -->
            <div class="section-title">
                <i class="fas fa-check-circle"></i>
                <span>Équipements et commodités</span>
            </div>

            <div class="checkbox-grid">
                <div class="checkbox-item">
                    <input type="checkbox" name="is_meuble" id="is_meuble" value="true">
                    <label for="is_meuble">Meublé</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" name="has_balcon" id="has_balcon" value="true">
                    <label for="has_balcon">Balcon</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" name="has_parking" id="has_parking" value="true">
                    <label for="has_parking">Parking</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" name="has_climatisation" id="has_climatisation" value="true">
                    <label for="has_climatisation">Climatisation</label>
                </div>
            </div>

            <!-- Description -->
            <div class="form-group" style="margin-top: 2rem;">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" placeholder="Description détaillée de l'appartement..."></textarea>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Enregistrer l'appartement
                </button>
            </div>
        </form>
    </div>

    <!-- Bannière d'information -->
    <div class="info-banner">
        <h4>
            <i class="fas fa-lightbulb"></i>
            Conseils pour un enregistrement réussi
        </h4>
        <ul class="info-list">
            <li><i class="fas fa-check-circle"></i> Assurez-vous que le propriétaire existe dans le système</li>
            <li><i class="fas fa-check-circle"></i> Vérifiez l'exactitude de l'adresse pour la géolocalisation</li>
            <li><i class="fas fa-check-circle"></i> Les informations financières peuvent être modifiées ultérieurement</li>
            <li><i class="fas fa-check-circle"></i> Pensez à ajouter des photos après l'enregistrement</li>
        </ul>
    </div>
</div>

<script>
let selectedType = null;

function selectType(type) {
    selectedType = type;

    // Met à jour les cartes
    document.getElementById('card-residence').classList.remove('active');
    document.getElementById('card-appartement').classList.remove('active');
    document.getElementById(`card-${type}`).classList.add('active');

    // Affiche/masque les formulaires
    document.getElementById('form-residence').classList.remove('active');
    document.getElementById('form-appartement').classList.remove('active');
    document.getElementById(`form-${type}`).classList.add('active');

    // Défilement fluide vers le formulaire
    setTimeout(() => {
        document.getElementById(`form-${type}`).scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }, 150);
}

function resetForm() {
    if (confirm('Voulez-vous vraiment annuler ? Toutes les données saisies seront perdues.')) {
        // Réinitialise la sélection
        selectedType = null;
        document.getElementById('card-residence').classList.remove('active');
        document.getElementById('card-appartement').classList.remove('active');
        document.getElementById('form-residence').classList.remove('active');
        document.getElementById('form-appartement').classList.remove('active');

        // Réinitialise les formulaires
        document.querySelectorAll('form').forEach(form => form.reset());

        // Défile vers le haut
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Validation des formulaires
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');

    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            let firstInvalidField = null;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('error');
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                } else {
                    field.classList.remove('error');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert('Veuillez remplir tous les champs obligatoires.');
                if (firstInvalidField) {
                    firstInvalidField.focus();
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }
        });
    });

    // Supprime l'erreur lors de la saisie
    document.querySelectorAll('.form-control').forEach(field => {
        field.addEventListener('input', function() {
            this.classList.remove('error');
        });
    });

    // Calcul automatique du dépôt de garantie
    const loyerInput = document.querySelector('input[name="loyer_base"]');
    const depotInput = document.querySelector('input[name="depot_garantie"]');

    if (loyerInput && depotInput) {
        loyerInput.addEventListener('input', function() {
            const loyer = parseFloat(this.value) || 0;
            if (!depotInput.value || depotInput.value == 0) {
                depotInput.value = loyer * 2; // 2 mois par défaut
            }
        });
    }
});
</script>
{% endblock %}
