{% load static %}
{# Composant réutilisable: Card Travail #}
{# Usage: {% include 'includes/travail_card.html' with travail=travail %} #}

<div class="travail-card bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
     data-id="{{ travail.id }}"
     onclick="window.location.href='{% url 'maintenance:travail_detail' travail.pk %}'">

    <!-- En-tête avec badges -->
    <div class="flex justify-between items-start mb-3">
        <div class="flex-1">
            <!-- Badge Nature -->
            {% if travail.nature == 'reactif' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 mr-2">
                <i class="fas fa-exclamation-circle mr-1"></i>Réactif
            </span>
            {% elif travail.nature == 'planifie' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 mr-2">
                <i class="fas fa-calendar-check mr-1"></i>Planifié
            </span>
            {% elif travail.nature == 'preventif' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 mr-2">
                <i class="fas fa-shield-alt mr-1"></i>Préventif
            </span>
            {% elif travail.nature == 'projet' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 mr-2">
                <i class="fas fa-project-diagram mr-1"></i>Projet
            </span>
            {% endif %}

            <!-- Badge Priorité -->
            {% if travail.priorite == 'urgente' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                <i class="fas fa-circle text-red-600 mr-1 text-xs"></i>Urgente
            </span>
            {% elif travail.priorite == 'haute' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800">
                <i class="fas fa-circle text-orange-600 mr-1 text-xs"></i>Haute
            </span>
            {% elif travail.priorite == 'normale' %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                <i class="fas fa-circle text-yellow-600 mr-1 text-xs"></i>Normale
            </span>
            {% else %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                <i class="fas fa-circle text-green-600 mr-1 text-xs"></i>Basse
            </span>
            {% endif %}
        </div>

        <!-- Numéro -->
        <span class="text-xs font-mono text-gray-500">{{ travail.numero_travail }}</span>
    </div>

    <!-- Titre et description -->
    <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ travail.titre }}</h3>
    <p class="text-sm text-gray-600 mb-3 line-clamp-2">{{ travail.description|truncatewords:15 }}</p>

    <!-- Type de travail -->
    <div class="flex items-center mb-3">
        <i class="fas fa-tools text-gray-400 mr-2"></i>
        <span class="text-sm text-gray-700">{{ travail.get_type_travail_display }}</span>
    </div>

    <!-- Localisation -->
    {% if travail.appartement %}
    <div class="flex items-center mb-3">
        <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
        <span class="text-sm text-gray-700">{{ travail.appartement.residence.nom }} - {{ travail.appartement.numero }}</span>
    </div>
    {% elif travail.residence %}
    <div class="flex items-center mb-3">
        <i class="fas fa-building text-gray-400 mr-2"></i>
        <span class="text-sm text-gray-700">{{ travail.residence.nom }}</span>
    </div>
    {% endif %}

    <!-- Demandes d'achat liées (Architecture 1-to-Many) -->
    {% if travail.necessite_materiel %}
    <div class="mb-3 p-2 bg-purple-50 border-l-2 border-purple-500 rounded">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-shopping-cart text-purple-600 mr-2 text-xs"></i>
                <span class="text-xs font-medium text-purple-900">{{ travail.demandes_achat.count }} demande(s)</span>
            </div>
            <div class="text-right">
                <span class="text-xs text-purple-700 font-semibold">{{ travail.cout_total_materiel|floatformat:0 }} F</span>
                <!-- Badge statut matériel -->
                {% if travail.statut_materiel == 'materiel_recu' %}
                <span class="inline-block ml-1 px-1.5 py-0.5 rounded text-xs bg-green-100 text-green-800">
                    <i class="fas fa-check text-xs"></i>
                </span>
                {% elif travail.statut_materiel == 'en_attente_reception' %}
                <span class="inline-block ml-1 px-1.5 py-0.5 rounded text-xs bg-orange-100 text-orange-800">
                    <i class="fas fa-clock text-xs"></i>
                </span>
                {% elif travail.statut_materiel == 'en_attente_validation' %}
                <span class="inline-block ml-1 px-1.5 py-0.5 rounded text-xs bg-yellow-100 text-yellow-800">
                    <i class="fas fa-hourglass-half text-xs"></i>
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Footer: Assigné + Statut + Date -->
    <div class="flex items-center justify-between pt-3 border-t border-gray-200">
        <!-- Assigné à -->
        <div class="flex items-center">
            {% if travail.assigne_a %}
            <div class="h-6 w-6 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                <span class="text-xs font-medium text-blue-600">
                    {{ travail.assigne_a.first_name.0 }}{{ travail.assigne_a.last_name.0 }}
                </span>
            </div>
            <span class="text-xs text-gray-700">{{ travail.assigne_a.get_full_name|truncatechars:15 }}</span>
            {% else %}
            <span class="text-xs text-gray-400 italic">Non assigné</span>
            {% endif %}
        </div>

        <!-- Statut -->
        <div>
            {% include 'includes/travail_status_badge.html' with statut=travail.statut size='small' %}
        </div>
    </div>

    <!-- Date prévue si existe et en retard -->
    {% if travail.date_prevue %}
    <div class="mt-2 text-xs {% if travail.est_en_retard %}text-red-600{% else %}text-gray-500{% endif %}">
        <i class="fas fa-calendar mr-1"></i>
        {{ travail.date_prevue|date:"d/m/Y" }}
        {% if travail.est_en_retard %}
        <i class="fas fa-exclamation-triangle ml-1"></i>
        {% endif %}
    </div>
    {% endif %}
</div>
