{% load static %}
{# Composant réutilisable: Mini-card Demande d'Achat #}
{# Usage (Une seule demande): {% include 'includes/demande_achat_mini_card.html' with demande=demande %} #}
{# Usage (Depuis travail - première demande): {% include 'includes/demande_achat_mini_card.html' with demande=travail.demandes_achat.first %} #}

{% if demande %}
<div class="demande-mini-card bg-purple-50 border-l-4 border-purple-500 rounded-lg p-4">
    <div class="flex justify-between items-start mb-3">
        <div class="flex-1">
            <h4 class="font-semibold text-purple-900 flex items-center">
                <i class="fas fa-shopping-cart mr-2"></i>
                Demande d'Achat
            </h4>
            <p class="text-sm text-purple-700 mt-1">{{ demande.numero_facture }}</p>
        </div>

        <!-- Badge statut -->
        {% if demande.etape_workflow == 'brouillon' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
            Brouillon
        </span>
        {% elif demande.etape_workflow == 'en_attente' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
            En attente
        </span>
        {% elif demande.etape_workflow == 'valide_responsable' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
            Validé
        </span>
        {% elif demande.etape_workflow == 'comptable' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">
            Comptable
        </span>
        {% elif demande.etape_workflow == 'validation_dg' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
            Validation DG
        </span>
        {% elif demande.etape_workflow == 'approuve' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
            Approuvé
        </span>
        {% elif demande.etape_workflow == 'recue' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-teal-100 text-teal-800">
            Réceptionné
        </span>
        {% elif demande.etape_workflow == 'paye' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-emerald-100 text-emerald-800">
            Payé
        </span>
        {% elif demande.etape_workflow == 'refuse' %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
            Refusé
        </span>
        {% endif %}
    </div>

    <!-- Motif -->
    {% if demande.motif_principal %}
    <p class="text-sm text-purple-700 mb-3">
        {{ demande.motif_principal|truncatewords:15 }}
    </p>
    {% endif %}

    <!-- Détails -->
    <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
            <p class="text-xs text-purple-600">Demandeur</p>
            <p class="text-sm font-medium text-purple-900">{{ demande.demandeur.get_full_name|truncatechars:20 }}</p>
        </div>
        <div>
            <p class="text-xs text-purple-600">Date</p>
            <p class="text-sm font-medium text-purple-900">{{ demande.date_demande|date:"d/m/Y" }}</p>
        </div>
    </div>

    <!-- Footer avec montant et lien -->
    <div class="flex justify-between items-center pt-3 border-t border-purple-200">
        <span class="text-lg font-bold text-purple-600">
            {{ demande.montant_ttc|floatformat:0 }} FCFA
        </span>
        <a href="{% url 'payments:demande_achat_detail' demande.pk %}"
           class="inline-flex items-center text-purple-600 hover:text-purple-800 text-sm font-medium">
            Voir détail
            <i class="fas fa-arrow-right ml-2"></i>
        </a>
    </div>
</div>
{% else %}
<!-- Message si pas de demande -->
<div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
    <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i>
    <p class="text-sm text-gray-600">Aucune demande d'achat liée</p>
</div>
{% endif %}
