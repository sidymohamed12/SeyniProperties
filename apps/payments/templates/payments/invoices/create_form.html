<!-- apps/payments/templates/payments/invoices/create_form.html -->

{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ titre }} - Imani{% endblock %}

{% block page_title %}{{ titre }}{% endblock %}
{% block page_subtitle %}Créer une nouvelle facture{% endblock %}

{% block content %}
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-600">
            <li><a href="{% url 'dashboard:index' %}" class="hover:text-imani-primary"><i class="fas fa-home"></i></a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li><a href="{% url 'payments:invoices_list' %}" class="hover:text-blue-600">Factures</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li><a href="{% url 'payments:invoice_create_menu' %}" class="hover:text-blue-600">Créer</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li class="text-gray-900 font-medium">{{ type_facture }}</li>
        </ol>
    </nav>
    
    <!-- En-tête -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="bg-{{ color }}-100 p-4 rounded-lg mr-4">
                    <i class="fas {{ icon }} text-3xl text-{{ color }}-600"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-1">
                        {{ titre }}
                    </h1>
                    <p class="text-gray-600">
                        Remplissez les informations de la facture
                    </p>
                </div>
            </div>
            
            <a href="{% url 'payments:invoice_create_menu' %}" 
               class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Retour
            </a>
        </div>
    </div>
    
    <!-- Formulaire -->
    <form method="post" class="max-w-5xl mx-auto">
        {% csrf_token %}
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            
            <!-- Section 1: Contrat ou Informations client -->
            <div class="border-b border-gray-200 bg-gradient-to-r from-{{ color }}-500 to-{{ color }}-600 px-6 py-4">
                <h2 class="text-xl font-semibold text-white">
                    <i class="fas fa-user mr-2"></i>
                    1. {% if form.contrat %}Sélection du Contrat{% else %}Informations Client{% endif %}
                </h2>
            </div>
            
            <div class="p-6 space-y-6">
                
                {% if form.contrat %}
                <!-- FACTURE LOYER : Sélection de contrat -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Contrat de location <span class="text-red-500">*</span>
                    </label>
                    {{ form.contrat }}
                    {% if form.contrat.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.contrat.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Le montant sera automatiquement rempli depuis le contrat sélectionné
                    </p>
                </div>
                
                <!-- Panneau d'information du contrat -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4" id="contrat-info" style="display: none;">
                    <h3 class="font-semibold text-blue-900 mb-3">
                        <i class="fas fa-info-circle mr-2"></i>
                        Informations du contrat
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-blue-700 font-medium">Locataire :</span>
                            <span id="info-locataire" class="text-blue-900 ml-2"></span>
                        </div>
                        <div>
                            <span class="text-blue-700 font-medium">Bien :</span>
                            <span id="info-bien" class="text-blue-900 ml-2"></span>
                        </div>
                        <div>
                            <span class="text-blue-700 font-medium">Loyer mensuel :</span>
                            <span id="info-loyer" class="text-blue-900 font-bold ml-2"></span>
                        </div>
                        <div>
                            <span class="text-blue-700 font-medium">Période :</span>
                            <span id="info-periode" class="text-blue-900 ml-2"></span>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <!-- AUTRES FACTURES : Informations manuelles -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    {% if form.destinataire_nom %}
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nom du destinataire <span class="text-red-500">*</span>
                        </label>
                        {{ form.destinataire_nom }}
                        {% if form.destinataire_nom.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.destinataire_nom.errors.0 }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if form.fournisseur_nom %}
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nom du prestataire <span class="text-red-500">*</span>
                        </label>
                        {{ form.fournisseur_nom }}
                        {% if form.fournisseur_nom.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.fournisseur_nom.errors.0 }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if form.destinataire_adresse %}
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Adresse
                        </label>
                        {{ form.destinataire_adresse }}
                        {% if form.destinataire_adresse.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.destinataire_adresse.errors.0 }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if form.destinataire_email %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Email
                        </label>
                        {{ form.destinataire_email }}
                        {% if form.destinataire_email.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.destinataire_email.errors.0 }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if form.destinataire_telephone %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Téléphone
                        </label>
                        {{ form.destinataire_telephone }}
                        {% if form.destinataire_telephone.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.destinataire_telephone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Champs spécifiques selon le type -->
                    {% if form.reference_copropriete %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Référence Copropriété
                        </label>
                        {{ form.reference_copropriete }}
                    </div>
                    {% endif %}
                    
                    {% if form.trimestre %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Trimestre <span class="text-red-500">*</span>
                        </label>
                        {{ form.trimestre }}
                    </div>
                    {% endif %}
                    
                    {% if form.fournisseur_reference %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Référence Fournisseur
                        </label>
                        {{ form.fournisseur_reference }}
                    </div>
                    {% endif %}
                    
                    {% if form.type_prestation %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Type de Prestation <span class="text-red-500">*</span>
                        </label>
                        {{ form.type_prestation }}
                    </div>
                    {% endif %}
                    
                    {% if form.numero_bon_commande %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Numéro Bon de Commande
                        </label>
                        {{ form.numero_bon_commande }}
                    </div>
                    {% endif %}
                    
                    {% if form.categorie_achat %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Catégorie d'Achat <span class="text-red-500">*</span>
                        </label>
                        {{ form.categorie_achat }}
                    </div>
                    {% endif %}
                    
                </div>
                {% endif %}
                
            </div>
            
            <!-- Section 2: Dates et périodes -->
            <div class="border-b border-gray-200 bg-gradient-to-r from-{{ color }}-500 to-{{ color }}-600 px-6 py-4">
                <h2 class="text-xl font-semibold text-white">
                    <i class="fas fa-calendar mr-2"></i>
                    2. Dates et Périodes
                </h2>
            </div>
            
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {% if form.periode_debut %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Période Début <span class="text-red-500">*</span>
                    </label>
                    {{ form.periode_debut }}
                    {% if form.periode_debut.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.periode_debut.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Période Fin <span class="text-red-500">*</span>
                    </label>
                    {{ form.periode_fin }}
                    {% if form.periode_fin.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.periode_fin.errors.0 }}</p>
                    {% endif %}
                </div>
                {% endif %}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Date d'Émission <span class="text-red-500">*</span>
                    </label>
                    {{ form.date_emission }}
                    {% if form.date_emission.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.date_emission.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Date d'Échéance <span class="text-red-500">*</span>
                    </label>
                    {{ form.date_echeance }}
                    {% if form.date_echeance.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.date_echeance.errors.0 }}</p>
                    {% endif %}
                </div>
                
            </div>
            
            <!-- Section 3: Montants -->
            <div class="border-b border-gray-200 bg-gradient-to-r from-{{ color }}-500 to-{{ color }}-600 px-6 py-4">
                <h2 class="text-xl font-semibold text-white">
                    <i class="fas fa-money-bill-wave mr-2"></i>
                    3. Montants
                </h2>
            </div>
            
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Montant HT (FCFA) <span class="text-red-500">*</span>
                    </label>
                    {{ form.montant_ht }}
                    {% if form.montant_ht.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.montant_ht.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">Montant hors taxes</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Taux TVA (%) <span class="text-red-500">*</span>
                    </label>
                    {{ form.taux_tva }}
                    {% if form.taux_tva.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.taux_tva.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">18% par défaut au Sénégal</p>
                </div>
                
                <div class="md:col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-blue-900">
                            <i class="fas fa-calculator mr-2"></i>
                            Le montant TTC sera calculé automatiquement
                        </span>
                        <span class="text-lg font-bold text-blue-900" id="montant_ttc_preview">
                            0 FCFA
                        </span>
                    </div>
                </div>
                
            </div>
            
            <!-- Section 4: Description -->
            <div class="border-b border-gray-200 bg-gradient-to-r from-{{ color }}-500 to-{{ color }}-600 px-6 py-4">
                <h2 class="text-xl font-semibold text-white">
                    <i class="fas fa-file-alt mr-2"></i>
                    4. Description et Notes
                </h2>
            </div>
            
            <div class="p-6 space-y-6">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Notes internes
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.notes.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">Ces notes ne seront pas visibles sur le PDF</p>
                </div>
                
            </div>
            
            <!-- Boutons d'action -->
            <div class="bg-gray-50 px-6 py-4 flex items-center justify-between">
                <a href="{% url 'payments:invoice_create_menu' %}" 
                   class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Annuler
                </a>
                
                <button type="submit" 
                        class="px-8 py-3 bg-{{ color }}-600 text-white rounded-lg hover:bg-{{ color }}-700 transition-colors font-semibold">
                    <i class="fas fa-check mr-2"></i>
                    Créer la Facture
                </button>
            </div>
            
        </div>
    </form>
    
</div>

<!-- Script pour calcul TTC et auto-complétion -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const montantHTInput = document.querySelector('input[name="montant_ht"]');
    const tauxTVAInput = document.querySelector('input[name="taux_tva"]');
    const montantTTCPreview = document.getElementById('montant_ttc_preview');
    
    function calculateTTC() {
        const ht = parseFloat(montantHTInput.value) || 0;
        const tva = parseFloat(tauxTVAInput.value) || 0;
        const ttc = ht + (ht * tva / 100);
        
        montantTTCPreview.textContent = ttc.toLocaleString('fr-FR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }) + ' FCFA';
    }
    
    if (montantHTInput && tauxTVAInput) {
        montantHTInput.addEventListener('input', calculateTTC);
        tauxTVAInput.addEventListener('input', calculateTTC);
        calculateTTC();
    }
    
    // Auto-complétion pour facture loyer
    const contratSelect = document.getElementById('id_contrat');
    if (contratSelect) {
        contratSelect.addEventListener('change', function() {
            const contratId = this.value;
            if (!contratId) {
                document.getElementById('contrat-info').style.display = 'none';
                return;
            }
            
            document.getElementById('contrat-info').style.display = 'block';
            document.getElementById('info-locataire').textContent = 'Chargement...';
            document.getElementById('info-bien').textContent = 'Chargement...';
            document.getElementById('info-loyer').textContent = 'Chargement...';
            document.getElementById('info-periode').textContent = 'Chargement...';
            
            // Appel AJAX
            fetch(`/contracts/api/${contratId}/info/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('info-locataire').textContent = data.locataire;
                        document.getElementById('info-bien').textContent = data.bien;
                        document.getElementById('info-loyer').textContent = data.loyer_mensuel + ' FCFA';
                        document.getElementById('info-periode').textContent = data.periode;
                        
                        if (montantHTInput) {
                            montantHTInput.value = data.loyer_mensuel_raw;
                            calculateTTC();
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                });
        });
    }
});
</script>
{% endblock %}